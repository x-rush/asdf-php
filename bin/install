#!/usr/bin/env bash

set -eo pipefail

# ===================================================================
# asdf PHP Plugin - Enhanced Version
# Features: Platform compatibility, Zero-config, Multi-version support
# ===================================================================


# Simplified freetype configuration - only for PHP 7.4+
configure_freetype_intelligently() {
    local php_version=$1
    local freetype_path=$(find_library_path "freetype")
    local php_major=$(echo "$php_version" | cut -d. -f1)
    local php_minor=$(echo "$php_version" | cut -d. -f2)

    # Only enable freetype for PHP 7.4+ where pkg-config is natively supported
    if [[ "$php_major" == "7" && "$php_minor" -ge 4 ]] || [[ "$php_major" == "8" ]]; then
        # Modern PHP versions use pkg-config natively
        if [[ -n "$freetype_path" ]] && command -v pkg-config >/dev/null 2>&1 && pkg-config --exists freetype2 2>/dev/null; then
            echo "--with-freetype"
        fi
    fi
    # For PHP 7.3 and below: skip freetype entirely to avoid compilation issues
}

# System compatibility functions
detect_system_info() {
    local os=$(uname -s)
    local arch=$(uname -m)
    local distro=""
    local package_manager=""

    # Normalize architecture names
    case "$arch" in
        "x86_64") arch="x86_64" ;;
        "arm64"|"aarch64") arch="arm64" ;;
        "i386"|"i686") arch="x86" ;;
        *) arch="$arch" ;;
    esac

    # Detect Linux distribution
    if [[ "$os" == "Linux" ]]; then
        if [[ -f /etc/os-release ]]; then
            distro=$(grep "^ID=" /etc/os-release | cut -d= -f2 | tr -d '"')
        elif [[ -f /etc/redhat-release ]]; then
            distro="rhel"
        elif [[ -f /etc/debian_version ]]; then
            distro="debian"
        fi

        # Detect package manager
        if command -v apt-get >/dev/null 2>&1; then
            package_manager="apt"
        elif command -v yum >/dev/null 2>&1 || command -v dnf >/dev/null 2>&1; then
            package_manager="yum"
        elif command -v pacman >/dev/null 2>&1; then
            package_manager="pacman"
        elif command -v zypper >/dev/null 2>&1; then
            package_manager="zypper"
        fi
    fi

    echo "${os}|${arch}|${distro}|${package_manager}"
}

check_system_compatibility() {
    local system_info=$(detect_system_info)
    local os=$(echo "$system_info" | cut -d'|' -f1)
    local arch=$(echo "$system_info" | cut -d'|' -f2)
    local distro=$(echo "$system_info" | cut -d'|' -f3)
    local package_manager=$(echo "$system_info" | cut -d'|' -f4)
    local missing_tools=()

    # Detect container environment
    local is_container=false
    if [[ -f /.dockerenv ]] || grep -q 'docker\|lxc\|containerd' /proc/1/cgroup 2>/dev/null; then
        is_container=true
        export MAKEFLAGS="-j2"  # Reduce parallel compilation in containers
    fi

    # Check required tools
    local required_tools=("autoconf" "bison" "gcc" "make" "wget" "curl")
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" >/dev/null 2>&1; then
            missing_tools+=("$tool")
        fi
    done

    # Platform-specific checks
    if [[ "$os" == "Darwin" ]]; then
        # macOS checks
        if ! command -v brew >/dev/null 2>&1; then
            echo "‚ùå Homebrew not found"
            echo "üîß Install from: https://brew.sh/"
            return 1
        fi

        # Apple Silicon special handling
        if [[ "$arch" == "arm64" ]]; then
        echo "üçé Detected Apple Silicon (ARM64)"
            export PATH="/opt/homebrew/bin:$PATH"
        fi
    else
        # Linux checks
        if ! command -v pkg-config >/dev/null 2>&1; then
            missing_tools+=("pkg-config")
        fi
    fi

    # Report missing tools
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        echo "‚ùå Missing required tools: ${missing_tools[*]}"
        if [[ "$os" == "Darwin" ]]; then
            echo "üîß Install with: brew install ${missing_tools[*]}"
        else
            echo "üîß Install with: sudo apt-get install ${missing_tools[*]}"
        fi
        return 1
    fi

    echo "‚úÖ System compatibility: $os $arch"
    return 0
}

# OpenSSL auto-management functions
get_openssl_version_for_php() {
    local php_version=$1
    local major=$(echo "$php_version" | cut -d. -f1)

    case "$major" in
        "5") echo "1.0.2u" ;;    # PHP 5.x needs OpenSSL 1.0.2
        "7") echo "1.1.1w" ;;    # PHP 7.x needs OpenSSL 1.1.x
        "8")
            local minor=$(echo "$php_version" | cut -d. -f2)
            if [[ "$minor" -lt 1 ]]; then
                echo "1.1.1w"  # PHP 8.0 needs OpenSSL 1.1.x
            else
                echo "system"   # PHP 8.1+ can use system OpenSSL
            fi
            ;;
        *) echo "system" ;;
    esac
}

get_openssl_target() {
    local os=$(uname -s)
    local arch=$(echo "$(detect_system_info)" | cut -d'|' -f2)

    case "$os-$arch" in
        "Darwin-arm64") echo "darwin64-arm64-cc" ;;
        "Darwin-x86_64") echo "darwin64-x86_64-cc" ;;
        "Linux-arm64") echo "linux-aarch64" ;;
        "Linux-x86_64") echo "linux-x86_64" ;;
        *) echo "no-asm" ;;
    esac
}

compile_openssl_from_source() {
    local version=$1
    local install_prefix=$2

    if [[ -d "$install_prefix" && -f "$install_prefix/bin/openssl" ]]; then
        echo "‚úÖ OpenSSL $version already compiled"
        return 0
    fi

    echo "üì¶ Compiling OpenSSL $version..."
    mkdir -p "$install_prefix"

    local tmp_dir=$(mktemp -d)
    cd "$tmp_dir"

    # Download source code
    local openssl_url="https://www.openssl.org/source/openssl-${version}.tar.gz"
    echo "   Downloading: $openssl_url"

    if ! wget "$openssl_url"; then
        echo "‚ùå Failed to download OpenSSL $version"
        return 1
    fi

    # Compile and install
    tar xzf "openssl-${version}.tar.gz"
    cd "openssl-${version}"

    local target=$(get_openssl_target)
    local config_args="--prefix=$install_prefix -fPIC -shared $target"

    echo "   Configure: $config_args"
    ./Configure $config_args || return 1

    local cpu_count=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
    make -j"$cpu_count" || return 1
    make install || return 1

    # Cleanup
    cd /
    rm -rf "$tmp_dir"

    echo "‚úÖ OpenSSL $version compiled successfully"

    # Set environment variables
    export PKG_CONFIG_PATH="${install_prefix}/lib/pkgconfig:${PKG_CONFIG_PATH}"
    export LD_LIBRARY_PATH="${install_prefix}/lib:${LD_LIBRARY_PATH}"
    return 0
}

setup_openssl_for_php_version() {
    local php_version=$1
    local required_version=$(get_openssl_version_for_php "$php_version")

    echo "üîê Setting up OpenSSL for PHP $php_version..."
    echo "   Required version: $required_version"

    # Skip compilation if system version is compatible
    if [[ "$required_version" == "system" ]]; then
        echo "‚è≠Ô∏è  Using system OpenSSL (PHP 8.1+ compatible)"
        return 0
    fi

    # Check system OpenSSL compatibility
    if command -v pkg-config >/dev/null 2>&1 && pkg-config --exists openssl; then
        local system_version=$(pkg-config --modversion openssl 2>/dev/null)
        if [[ "$required_version" =~ ^1\.0\. && "$system_version" =~ ^1\.0\. ]]; then
            echo "‚úÖ System OpenSSL $system_version is compatible"
            return 0
        elif [[ "$required_version" =~ ^1\.1\. && "$system_version" =~ ^1\.1\. ]]; then
            echo "‚úÖ System OpenSSL $system_version is compatible"
            return 0
        fi
    fi

    # Auto-compile OpenSSL if needed
    local install_dir="$HOME/.asdf/openssl/$required_version"
    if ! compile_openssl_from_source "$required_version" "$install_dir"; then
        echo "‚ùå Failed to compile OpenSSL $required_version"
        return 1
    fi

    # Set environment variables for PHP compilation
    export PKG_CONFIG_PATH="$install_dir/lib/pkgconfig:$PKG_CONFIG_PATH"
    export LDFLAGS="-L$install_dir/lib $LDFLAGS"
    export CPPFLAGS="-I$install_dir/include $CPPFLAGS"
    export PATH="$install_dir/bin:$PATH"

    echo "‚úÖ OpenSSL setup completed"
    echo "   Using custom OpenSSL: $install_dir"
    return 0
}

# Multi-platform library path detection
find_library_path() {
    local lib_name=$1
    local system_info=$(detect_system_info)
    local os=$(echo "$system_info" | cut -d'|' -f1)
    local arch=$(echo "$system_info" | cut -d'|' -f2)

    # Common library search patterns
    local lib_patterns=(
        "lib${lib_name}.so"
        "lib${lib_name}.a"
        "${lib_name}.so"
        "${lib_name}.a"
    )

    # Platform-specific search paths
    local search_paths=()

    if [[ "$os" == "Darwin" ]]; then
        # macOS paths (Intel and Apple Silicon)
        if [[ "$arch" == "arm64" ]]; then
            search_paths=(
                "/opt/homebrew/lib"
                "/opt/homebrew/lib/$arch-linux-gnu"
                "/usr/local/lib"
                "/usr/lib"
            )
        else
            search_paths=(
                "/usr/local/lib"
                "/usr/local/Cellar"
                "/opt/homebrew/lib"
                "/usr/lib"
            )
        fi
    else
        # Linux paths with architecture awareness
        if [[ "$arch" == "arm64" ]]; then
            search_paths=(
                "/usr/lib/aarch64-linux-gnu"
                "/usr/lib64"
                "/usr/lib"
                "/usr/local/lib"
                "/lib/aarch64-linux-gnu"
                "/lib64"
            )
        else
            search_paths=(
                "/usr/lib/x86_64-linux-gnu"
                "/usr/lib64"
                "/usr/lib"
                "/usr/local/lib"
                "/lib/x86_64-linux-gnu"
                "/lib64"
            )
        fi
    fi

    # Search for library
    for path in "${search_paths[@]}"; do
        for pattern in "${lib_patterns[@]}"; do
            if [[ -f "$path/$pattern" ]]; then
                echo "$path"
                return 0
            fi
        done
    done

    return 1
}

# Enhanced platform-specific library detection
detect_library_paths() {
    local os=$(uname -s)
    local system_info=$(detect_system_info)
    local arch=$(echo "$system_info" | cut -d'|' -f2)
    local distro=$(echo "$system_info" | cut -d'|' -f3)
    local package_manager=$(echo "$system_info" | cut -d'|' -f4)

    local lib_paths=""
    local missing_libs=()

    # Detect essential libraries with platform awareness
    local libraries=("freetype" "jpeg" "png" "webp" "zip" "bz2")

    for lib in "${libraries[@]}"; do
        local lib_path=$(find_library_path "$lib")
        if [[ -n "$lib_path" ]]; then
            case "$lib" in
                "freetype")
                    lib_paths="$lib_paths --with-freetype-dir=$lib_path"
                    ;;
                "jpeg")
                    lib_paths="$lib_paths --with-jpeg-dir=$lib_path"
                    ;;
                "png")
                    lib_paths="$lib_paths --with-png-dir=$lib_path"
                    ;;
                "webp")
                    lib_paths="$lib_paths --with-webp-dir=$lib_path"
                    ;;
                "zip")
                    lib_paths="$lib_paths --with-libzip=$lib_path"
                    ;;
                "bz2")
                    lib_paths="$lib_paths --with-bz2=$lib_path"
                    ;;
            esac
        else
            missing_libs+=("$lib")
        fi
    done

    echo "$lib_paths"
}

# Library detection excluding GD-related libraries (to avoid duplication)
detect_library_paths_without_gd() {
    local os=$(uname -s)
    local system_info=$(detect_system_info)
    local arch=$(echo "$system_info" | cut -d'|' -f2)
    local distro=$(echo "$system_info" | cut -d'|' -f3)
    local package_manager=$(echo "$system_info" | cut -d'|' -f4)

    local lib_paths=""
    local missing_libs=()

    # Detect essential libraries EXCEPT GD-related ones (handled separately)
    local libraries=("zip" "bz2")

    for lib in "${libraries[@]}"; do
        local lib_path=$(find_library_path "$lib")
        if [[ -n "$lib_path" ]]; then
            case "$lib" in
                "zip")
                    lib_paths="$lib_paths --with-libzip=$lib_path"
                    ;;
                "bz2")
                    lib_paths="$lib_paths --with-bz2=$lib_path"
                    ;;
            esac
        else
            missing_libs+=("$lib")
        fi
    done

    echo "$lib_paths"
}

# Silent library checking (only report errors)
report_library_status() {
    local system_info=$(detect_system_info)
    local os=$(echo "$system_info" | cut -d'|' -f1)
    local package_manager=$(echo "$system_info" | cut -d'|' -f4)
    local missing_libs=()

    local libraries=("freetype" "jpeg" "png" "webp" "zip" "bz2")

    for lib in "${libraries[@]}"; do
        local lib_path=$(find_library_path "$lib")
        if [[ -z "$lib_path" ]]; then
            missing_libs+=("$lib")
        fi
    done

    # Only report if there are missing libraries
    if [[ ${#missing_libs[@]} -gt 0 ]]; then
        echo "‚ùå Missing required libraries: ${missing_libs[*]}" >&2
        if [[ "$os" == "Darwin" ]]; then
            echo "üîß Install with: brew install ${missing_libs[*]}" >&2
        elif [[ "$package_manager" == "apt" ]]; then
            echo "üîß Install with: sudo apt-get install ${missing_libs[*]}-dev" >&2
        elif [[ "$package_manager" == "yum" ]]; then
            echo "üîß Install with: sudo yum install ${missing_libs[*]}-devel" >&2
        elif [[ "$package_manager" == "pacman" ]]; then
            echo "üîß Install with: sudo pacman -S ${missing_libs[*]}" >&2
        else
            echo "üîß Please install development packages for: ${missing_libs[*]}" >&2
        fi
    fi
}

get_best_practice_extensions() {
    local php_version=$1
    local major=$(echo "$php_version" | cut -d. -f1)
    local minor=$(echo "$php_version" | cut -d. -f2)

    # Modern core extensions (2024 best practices) + compatibility with original script
    # GD extension will be handled separately with platform-specific logic
    local extensions="--enable-bcmath \
        --enable-calendar \
        --enable-dba \
        --enable-exif \
        --enable-fpm \
        --enable-mbstring \
        --enable-mysqlnd \
        --enable-opcache \
        --enable-pcntl \
        --enable-sockets \
        --enable-zip \
        --with-curl \
        --with-mysqli \
        --with-pdo-mysql \
        --with-zlib \
        --with-libzip \
        --with-bz2 \
        --enable-pdo \
        --enable-tokenizer \
        --enable-filter \
        --enable-fileinfo \
        --enable-dom \
        --enable-simplexml \
        --enable-xml \
        --enable-ftp \
        --enable-shmop \
        --enable-sysvmsg \
        --enable-sysvsem \
        --enable-sysvshm \
        --with-pdo-sqlite \
        --with-readline"

    # Version-specific best practice extensions - maintain each version's optimal features
    case "$major" in
        "5")
            # PHP 5.x - Legacy extensions (best practices for their era)
            extensions="$extensions --with-openssl --with-gd-native-ttf --with-gettext"
            # Add JSON and intl support (PHP 5.2+)
            if [[ "$minor" -ge 2 ]]; then
                extensions="$extensions --enable-json --enable-intl"
            fi
            # PHP 5.x specific legacy extensions
            extensions="$extensions --enable-wddx --with-mhash --with-mysql=mysqlnd --with-xmlrpc"
            # Add soap for older versions (useful for legacy web services)
            extensions="$extensions --enable-soap"
            ;;
        "7")
            # PHP 7.x - Modern extensions with legacy compatibility
            extensions="$extensions --with-openssl --with-pdo-pgsql --with-gettext"
            # Skip intl extension for PHP 7.2 due to compilation issues
            if [[ "$minor" -ne 2 ]]; then
                # Add intl extension for PHP 7.0, 7.1, 7.3, 7.4
                extensions="$extensions --enable-intl"
            fi
            # PHP 7.1+ modern features
            if [[ "$minor" -ge 1 ]]; then
                extensions="$extensions --enable-mysqlnd-compression-support"
            fi
            # PHP 7.4+ add sodium support (backport available)
            if [[ "$minor" -ge 4 ]]; then
                extensions="$extensions --with-sodium"
            fi
            # PHP 7.x still supports xmlrpc (removed in 8.0)
            extensions="$extensions --with-xmlrpc"
            ;;
        "8")
            # PHP 8.x - Cutting edge modern extensions (no legacy deprecated features)
            extensions="$extensions --with-openssl --with-sodium --with-pdo-pgsql --enable-intl --enable-soap --with-gettext"
            # PHP 8.1+ newer features
            if [[ "$minor" -ge 1 ]]; then
                extensions="$extensions --with-gmp"
            fi
            # PHP 8.2+ latest features
            if [[ "$minor" -ge 2 ]]; then
                extensions="$extensions --with-ffi"
            fi
            # Note: wddx, mhash, mysql, xmlrpc removed in PHP 8.0 - correctly omitted
            ;;
    esac

    # Report library status (separate from configure command)
    report_library_status

    # Multi-platform, multi-version GD extension configuration
    # This ensures GD extension works reliably across all environments
    extensions="$extensions $(configure_gd_extension "$php_version")"

    # Add remaining platform-specific library paths (excluding GD libraries already handled)
    local lib_paths=$(detect_library_paths_without_gd)
    extensions="$extensions $lib_paths"

    # PEAR is included by default (unless explicitly disabled)
    if [ "${PHP_WITHOUT_PEAR:-no}" != "no" ]; then
        extensions="$extensions --without-pear"
    else
        extensions="$extensions --with-pear"
    fi

    echo "$extensions"
}

# Multi-platform, multi-version GD extension configuration
configure_gd_extension() {
    local php_version=$1
    local major=$(echo "$php_version" | cut -d. -f1)
    local minor=$(echo "$php_version" | cut -d. -f2)
    local system_info=$(detect_system_info)
    local os=$(echo "$system_info" | cut -d'|' -f1)
    local arch=$(echo "$system_info" | cut -d'|' -f2)

    # Version-specific GD configuration
    local gd_config=""
    case "$major" in
        "5")
            # PHP 5.x: Basic GD configuration (from original script)
            gd_config="--enable-gd --with-gd"
            if [[ "$minor" -ge 2 ]]; then
                gd_config="$gd_config --enable-gd-native-ttf"
            fi
            ;;
        "7")
            # PHP 7.x: Use version-appropriate GD configuration
            gd_config="--with-gd"
            if [[ "$minor" -ge 1 ]]; then
                gd_config="$gd_config --enable-gd-native-ttf"
            fi
            if [[ "$minor" -ge 3 ]]; then
                # PHP 7.3+: Supports external GD
                gd_config="$gd_config --with-external-gd"
            fi
            ;;
        "8")
            # PHP 8.x: Enhanced GD configuration
            gd_config="--enable-gd --enable-gd-native-ttf --with-external-gd --with-gd"
            ;;
    esac

    # Intelligent freetype configuration based on PHP version
    local freetype_config=$(configure_freetype_intelligently "$php_version")
    if [[ -n "$freetype_config" ]]; then
        gd_config="$gd_config $freetype_config"
    fi

    # Platform-specific library configuration
    if [[ "$os" == "Darwin" ]]; then
        # macOS: Use Homebrew paths
        gd_config="$gd_config$(configure_gd_macos)"
    else
        # Linux: Use system library detection
        gd_config="$gd_config$(configure_gd_linux)"
    fi

    echo "$gd_config"
}

# macOS-specific GD configuration using Homebrew
configure_gd_macos() {
    local gd_config=""

    # Check for Homebrew-installed libraries (freetype handled intelligently)
    local jpeg_path=$(brew --prefix jpeg 2>/dev/null || echo "")
    local libpng_path=$(brew --prefix libpng 2>/dev/null || echo "")
    local webp_path=$(brew --prefix webp 2>/dev/null || echo "")

    # Add library paths if found
    if [[ -n "$jpeg_path" && -d "$jpeg_path" ]]; then
        gd_config="$gd_config --with-jpeg-dir=$jpeg_path"
    fi
    if [[ -n "$libpng_path" && -d "$libpng_path" ]]; then
        gd_config="$gd_config --with-png-dir=$libpng_path"
    fi
    if [[ -n "$webp_path" && -d "$webp_path" ]]; then
        gd_config="$gd_config --with-webp-dir=$webp_path"
    fi

    echo "$gd_config"
}

# Linux-specific GD configuration
configure_gd_linux() {
    local gd_config=""

    # Use locate command like the original script for better reliability
    local jpeg_path=$(locate libjpeg.so 2>/dev/null | awk '{ print length(), $0 | "sort -n" }' | cut -d" " -f2- | head -n 1)
    local png_path=$(locate libpng.so 2>/dev/null | awk '{ print length(), $0 | "sort -n" }' | cut -d" " -f2- | head -n 1)
    local webp_path=$(find_library_path "webp")

    # Extract directory paths from full file paths
    if [[ -n "$jpeg_path" ]]; then
        jpeg_path=$(dirname "$jpeg_path")
    fi
    if [[ -n "$png_path" ]]; then
        png_path=$(dirname "$png_path")
    fi

    # Add libraries using both --with-lib-dir and --with-lib patterns (original script approach)
    if [[ -n "$jpeg_path" ]]; then
        gd_config="$gd_config --with-jpeg-dir=$jpeg_path --with-jpeg"
    fi
    if [[ -n "$png_path" ]]; then
        gd_config="$gd_config --with-png-dir=$png_path --with-png"
    fi
    if [[ -n "$webp_path" ]]; then
        gd_config="$gd_config --with-webp-dir=$webp_path"
    fi

    echo "$gd_config"
}

# Optimized build configuration
get_optimized_make_flags() {
    local cpu_count=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)

    # Limit max concurrency to avoid memory issues
    if [[ $cpu_count -gt 4 ]]; then
        cpu_count=4
    fi

    echo "-j$cpu_count"
}

# Create balanced php.ini configuration for universal compatibility
create_basic_php_ini() {
    local install_path=$1
    local major=$(echo "$2" | cut -d. -f1)

    mkdir -p "$install_path/conf.d/"

    # Universal configuration - balanced for development and compatibility
    cat > "$install_path/conf.d/php.ini" << EOF
; PHP Configuration for asdf - Universal Environment
; Balanced settings for development, testing, and compatibility

; Basic Settings (Universal)
memory_limit = 128M
max_execution_time = 30
max_input_time = 60

; Error Reporting (Development-Ready but Safe)
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
display_errors = Off
display_startup_errors = Off
log_errors = On
error_log = "$install_path/conf.d/error.log"

; File Uploads (Reasonable defaults)
file_uploads = On
upload_max_filesize = 64M
post_max_size = 64M
max_file_uploads = 20

; Security and Compatibility
expose_php = Off
allow_url_fopen = On
allow_url_include = Off
variables_order = "EGPCS"
request_order = "GP"

; Session Settings (Universal)
session.save_handler = files
session.save_path = "$install_path/conf.d/sessions"
session.gc_maxlifetime = 1440
session.cookie_httponly = 1

; OPcache Configuration (Performance optimized)
opcache.enable = 1
opcache.enable_cli = 0
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 10000
opcache.revalidate_freq = 2
opcache.validate_timestamps = 1
opcache.fast_shutdown = 1
opcache.save_comments = 1
EOF

    # Version-specific configuration
    if [[ "$major" == "8" ]]; then
        cat >> "$install_path/conf.d/php.ini" << EOF

; PHP 8+ specific optimizations
opcache.validate_permission_maps = 1
; Conservative JIT settings for compatibility
opcache.jit_buffer_size = 64M
opcache.jit = 1205  ; Balanced optimization
EOF
    fi

    # Create sessions directory
    mkdir -p "$install_path/conf.d/sessions"

    # Fix SSL certificate verification for HTTPS requests
    setup_ssl_certificates "$install_path"

    echo "üìù Created universal php.ini: $install_path/conf.d/php.ini"
}

# Setup SSL certificates for HTTPS requests
setup_ssl_certificates() {
    local install_path=$1
    local ca_bundle_path="$install_path/conf.d/cacert.pem"

    echo "üîê Setting up SSL certificates for HTTPS..."

    # Try to download Mozilla CA bundle
    if command -v wget >/dev/null 2>&1; then
        if wget -q -O "$ca_bundle_path" "https://curl.se/ca/cacert.pem"; then
            echo "   ‚úÖ Downloaded Mozilla CA bundle"
        elif wget -q -O "$ca_bundle_path" "https://curl.haxx.se/ca/cacert.pem"; then
            echo "   ‚úÖ Downloaded Mozilla CA bundle (alternative source)"
        else
            echo "   ‚ö†Ô∏è  Failed to download CA bundle, trying system certificates"
            setup_system_certificates "$install_path"
            return 0
        fi
    elif command -v curl >/dev/null 2>&1; then
        if curl -s -o "$ca_bundle_path" "https://curl.se/ca/cacert.pem"; then
            echo "   ‚úÖ Downloaded Mozilla CA bundle"
        elif curl -s -o "$ca_bundle_path" "https://curl.haxx.se/ca/cacert.pem"; then
            echo "   ‚úÖ Downloaded Mozilla CA bundle (alternative source)"
        else
            echo "   ‚ö†Ô∏è  Failed to download CA bundle, trying system certificates"
            setup_system_certificates "$install_path"
            return 0
        fi
    else
        echo "   ‚ö†Ô∏è  Neither wget nor curl available, using system certificates"
        setup_system_certificates "$install_path"
        return 0
    fi

    # Add CA bundle configuration to php.ini
    cat >> "$install_path/conf.d/php.ini" << EOF

; SSL Certificate Configuration (for HTTPS requests)
openssl.cafile = "$ca_bundle_path"
openssl.capath = "/etc/ssl/certs"
EOF

    echo "   ‚úÖ SSL certificates configured"
}

# Fallback to system certificates
setup_system_certificates() {
    local install_path=$1

    # Try common system certificate paths
    local cert_paths=(
        "/etc/ssl/certs/ca-certificates.crt"
        "/etc/pki/tls/certs/ca-bundle.crt"
        "/usr/local/ssl/certs/ca-bundle.crt"
        "/etc/ssl/cert.pem"
    )

    for cert_path in "${cert_paths[@]}"; do
        if [ -f "$cert_path" ]; then
            cat >> "$install_path/conf.d/php.ini" << EOF

; SSL Certificate Configuration (system certificates)
openssl.cafile = "$cert_path"
openssl.capath = "/etc/ssl/certs"
EOF
            echo "   ‚úÖ Using system certificates: $cert_path"
            return 0
        fi
    done

    # Last resort: disable certificate verification (not recommended for production)
    cat >> "$install_path/conf.d/php.ini" << EOF

; SSL Certificate Configuration (development only - no verification)
; openssl.cafile =
; openssl.capath =
EOF
    echo "   ‚ö†Ô∏è  No system certificates found, SSL verification disabled (development only)"
}

# Create development helper scripts and configurations

install_php() {
  local install_type=$1
  local version=$2
  local install_path=$3
  local tmp_download_dir=$(mktemp -d)

  echo "üöÄ Installing PHP $version..."
  echo "   Platform: $(uname -s) $(detect_system_info)"
  
  # 1. System compatibility check
  if ! check_system_compatibility; then
    echo "‚ùå System compatibility check failed"
    exit 1
  fi

  # 2. Automatic OpenSSL environment setup
  if ! setup_openssl_for_php_version "$version"; then
    echo "‚ùå OpenSSL setup failed"
    exit 1
  fi

  # 3. Download and compile PHP
  local source_path=$(get_download_file_path $install_type $version $tmp_download_dir)
  download_source $install_type $version $source_path || exit 1

  (
    cd $(dirname $source_path)
    tar -zxf $source_path || exit 1
    cd $(untar_path $install_type $version $tmp_download_dir) || exit 1

    # Configuration and compilation
    local extensions=$(get_best_practice_extensions "$version")
    local make_flags=$(get_optimized_make_flags "${ASDF_CONCURRENCY:-}")

  
    # Preserve user custom configuration options if provided
    if [ "$PHP_CONFIGURE_OPTIONS" = "" ]; then
      local configure_options="$extensions --prefix=$install_path --sysconfdir=$install_path --with-config-file-path=$install_path --with-config-file-scan-dir=$install_path/conf.d"
    else
      local configure_options="$PHP_CONFIGURE_OPTIONS $extensions --prefix=$install_path --sysconfdir=$install_path --with-config-file-path=$install_path --with-config-file-scan-dir=$install_path/conf.d"
    fi

    
    if [ "${PHP_WITHOUT_PDO_PGSQL:-no}" = "no" ]; then
      local operating_system=$(uname -a)
      if [[ $operating_system =~ "Darwin" ]]; then
        local libpq_path=$(homebrew_package_path libpq)
        if [ -n "$libpq_path" ]; then
          configure_options="$configure_options --with-pdo-pgsql=$libpq_path"
        fi
      else
        configure_options="$configure_options --with-pdo-pgsql"
      fi
    fi

    if [ "${PHP_WITHOUT_PCRE_JIT:-no}" = "no" ]; then
      configure_options="$configure_options --without-pcre-jit"
    fi

    # Build PHP normally (no complex freetype wrapper needed)
    ./buildconf --force || exit 1
    ./configure $configure_options || exit 1
    make $make_flags || exit 1
    make $make_flags install || exit 1
  ) || exit 1

  # 4. Create optimized configuration
  create_basic_php_ini "$install_path" "$(echo "$version" | cut -d. -f1)"

  # 5. Cleanup and completion
  rm -rf "$tmp_download_dir"

  echo "‚úÖ PHP $version installed successfully!"
  echo "   Binary: $install_path/bin/php"
  echo "   Test: $install_path/bin/php --version"
}

install_composer() {
  local bin_path=$1/bin

  echo "   Downloading Composer installer..."

  # Try to download installer with SSL verification
  echo "   Downloading from https://getcomposer.org/installer..."
  if ! $bin_path/php -r "copy('https://getcomposer.org/installer', '$bin_path/composer-setup.php');" 2>/dev/null; then
    echo "   Failed to download Composer installer (SSL verification failed)"
    return 1
  fi

  # Verify file was downloaded and has content
  if [ ! -s "$bin_path/composer-setup.php" ]; then
    echo "   Composer installer file is empty or missing"
    return 1
  fi

  echo "   Installer downloaded, file size: $(wc -c < "$bin_path/composer-setup.php") bytes"

  # Download and verify signature
  local expected_signature="$(curl -sL https://composer.github.io/installer.sig 2>/dev/null)"
  if [ -z "$expected_signature" ]; then
    echo "   Failed to download Composer signature"
    rm -f "$bin_path/composer-setup.php"
    return 1
  fi

  # Verify installer
  cat > /tmp/verify_composer.php << EOF
<?php
\$expected = '${expected_signature}';
\$actual = hash_file('sha384', '${bin_path}/composer-setup.php');
if (\$expected === \$actual) {
    echo "Installer verified\n";
    exit(0);
} else {
    echo "Installer corrupt\n";
    unlink('${bin_path}/composer-setup.php');
    exit(1);
}
?>
EOF

  if ! $bin_path/php /tmp/verify_composer.php 2>/dev/null; then
    echo "   Composer installer verification failed"
    rm -f /tmp/verify_composer.php
    return 1
  fi

  rm -f /tmp/verify_composer.php

  # Install Composer
  if ! $bin_path/php "$bin_path/composer-setup.php" --install-dir=$bin_path --filename=composer 2>/dev/null; then
    echo "   Composer installation failed"
    rm -f "$bin_path/composer-setup.php"
    return 1
  fi

  # Cleanup
  $bin_path/php -r "unlink('$bin_path/composer-setup.php');" 2>/dev/null || true

  return 0
}

# Helper functions for package detection (used by enhanced install logic)
homebrew_package_path() {
  local package_name=$1

  if [ "$(brew ls --versions $package_name)" = "" ]; then
    echo ""
  else
    echo "$(brew --prefix $package_name)"
  fi
}


download_source() {
  local install_type=$1
  local version=$2
  local download_path=$3
  local download_url=$(get_download_url $install_type $version)

  # curl -Lo $download_path -C - $download_url
  curl -Lo $download_path $download_url
}

get_download_file_path() {
  local install_type=$1
  local version=$2
  local tmp_download_dir=$3
  local php_version=$(get_php_version $version)
  local pkg_name="php-${php_version}.tar.gz"

  echo "$tmp_download_dir/$pkg_name"
}

untar_path() {
  local install_type=$1
  local version=$2
  local tmp_download_dir=$3

  local php_version=$(get_php_version $version)

  local dir_name="php-src-php-${php_version}"

  echo "$tmp_download_dir/$dir_name"
}

get_download_url() {
  local install_type=$1
  local version=$2

  echo "https://github.com/php/php-src/archive/php-${version}.tar.gz"
}

get_php_version() {
  IFS='-' read -a version_info <<<"$1"

  if [ "${#version_info[@]}" -eq 1 ]; then
    echo "${version_info[0]}"
  else
    echo "${version_info[0]}-${version_info[1]}"
  fi
}

install_php "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"

# Install Composer (optional, failure won't affect PHP installation)
echo "üéµ Installing Composer..."
if install_composer "$ASDF_INSTALL_PATH"; then
  echo "‚úÖ Composer installed successfully"
else
  echo "‚ö†Ô∏è  Composer installation failed (SSL/Certificate issue)"
  echo "üí° You can install Composer manually later:"
  echo "   wget -O composer-setup.php https://getcomposer.org/installer"
  echo "   php composer-setup.php --install-dir=\$HOME/.local/bin --filename=composer"
fi
